<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b1020" />
  <title>Feliz 2026 ‚ú®</title>

  <style>
    :root{
      --bg:#0b1020;
      --text:#eef1ff;
      --muted:#b7c0ff;
      --accent:#ffd36a;
      --stroke:rgba(255,255,255,.16);
      --radius:22px;
    }
    *{box-sizing:border-box}

    body{
      margin:0; min-height:100vh;
      color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 700px at 18% 8%, #1b2a63 0%, transparent 58%),
        radial-gradient(900px 600px at 85% 20%, #103a4a 0%, transparent 60%),
        radial-gradient(900px 600px at 35% 88%, #3a2454 0%, transparent 60%),
        linear-gradient(180deg, #070a14 0%, var(--bg) 35%, #070a14 100%);
      overflow-x:hidden;
    }

    /* brillitos suaves */
    body::after{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background:
        radial-gradient(2px 2px at 12% 22%, rgba(255,255,255,.55), transparent 60%),
        radial-gradient(1.5px 1.5px at 28% 68%, rgba(255,255,255,.35), transparent 60%),
        radial-gradient(2px 2px at 76% 18%, rgba(255,255,255,.45), transparent 60%),
        radial-gradient(1.5px 1.5px at 84% 74%, rgba(255,255,255,.30), transparent 60%),
        radial-gradient(2px 2px at 46% 14%, rgba(255,255,255,.40), transparent 60%),
        radial-gradient(1.5px 1.5px at 52% 82%, rgba(255,255,255,.28), transparent 60%);
      opacity:.22;
      filter: blur(.2px);
    }

    .wrap{width:min(980px, 92vw); margin:0 auto; padding:22px 0 70px}

    header{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 6px; flex-wrap:wrap;
    }

    .hidden{display:none !important}

    .chip{
      display:inline-flex; align-items:center; gap:10px;
      padding:9px 12px;
      border:1px solid var(--stroke);
      border-radius:999px;
      background: rgba(255,255,255,.06);
      color:var(--muted);
      font-size:14px;
      backdrop-filter: blur(10px);
    }
    .chip b{color:var(--text)}

    .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center}

    /* ======== Control de audio ======== */
    .audioCtl{
      display:flex; align-items:center; gap:10px;
      padding:8px 10px;
      border:1px solid var(--stroke);
      border-radius:12px;
      background: rgba(255,255,255,.08);
      backdrop-filter: blur(10px);
      box-shadow: 0 14px 30px rgba(0,0,0,.25);
    }
    .volBtn{
      width:40px; height:38px;
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.14);
      border-radius:10px;
      background: rgba(0,0,0,.18);
      color:var(--text);
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      transition: transform .08s ease, background .18s ease, border-color .18s ease;
    }
    .volBtn:hover{
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.22);
    }
    .volBtn:active{transform: translateY(1px)}
    .volRange{width:130px; accent-color: var(--accent)}
    .volHint{font-size:12px; color:var(--muted); margin-left:4px}

    .panel{
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.03));
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      overflow:hidden;
      position:relative;
    }
    .panel::before{
      content:"";
      position:absolute; inset:-2px;
      pointer-events:none;
      background: radial-gradient(800px 280px at 20% 0%, rgba(255,211,106,.10), transparent 60%);
      opacity:.75;
    }

    /* HERO */
    .hero{margin-top:14px}
    .heroGrid{display:grid; grid-template-columns: 1fr 420px; gap:0}
    @media (max-width: 940px){ .heroGrid{grid-template-columns:1fr} }

    .left{padding:26px 22px 18px 22px; position:relative; z-index:1}
    .title{
      margin:0;
      font-size: clamp(28px, 3.6vw, 46px);
      line-height:1.06;
      letter-spacing:.2px;
    }
    .spark{
      color: var(--accent);
      text-shadow: 0 0 22px rgba(255,211,106,.25);
    }
    .subtitle{
      margin:12px 0 0 0;
      color:var(--muted);
      font-size:15px;
      line-height:1.7;
      max-width:62ch;
    }
    .hint{
      margin-top:12px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.14);
      color: rgba(255,255,255,.88);
      font-size:13px;
    }
    .hint span{opacity:.9}

    .right{
      border-left: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.08));
      padding:18px 18px 22px 18px;
      display:grid; place-items:center;
      position:relative;
      z-index:1;
    }
    @media (max-width: 940px){
      .right{border-left:0; border-top:1px solid rgba(255,255,255,.10)}
    }

    /* ===========================
       SOBRE
       =========================== */
    .envelope{
      --fit: cover;
      --pos: 50% 35%;
      --zoom: 1.02;
      --showBlur: 0;

      width: min(360px, 88vw);
      aspect-ratio: 4 / 3;
      position:relative;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transform: translateZ(0);
      border-radius: 20px;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      transition: transform .25s ease, box-shadow .25s ease, filter .25s ease;
      outline:none;
    }
    .envelope:hover{
      transform: translateY(-2px) scale(1.01);
      box-shadow: 0 26px 70px rgba(0,0,0,.52);
      filter: saturate(1.04);
    }
    .envelope:focus-visible{
      box-shadow: 0 26px 70px rgba(0,0,0,.52), 0 0 0 3px rgba(255,211,106,.25);
    }

    .envFrame{
      position:absolute; inset:0;
      border-radius: 20px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
    }
    .envPhoto{position:absolute; inset:0}
    .envPhoto img{width:100%; height:100%; display:block}
    .envPhoto .bg{
      position:absolute; inset:-30px;
      width: calc(100% + 60px);
      height: calc(100% + 60px);
      object-fit: cover;
      object-position: var(--pos);
      filter: blur(18px) saturate(1.15) contrast(1.05);
      transform: scale(1.18);
      opacity: calc(.85 * var(--showBlur));
      pointer-events:none;
    }
    .envPhoto .main{
      position:absolute; inset:0;
      object-fit: var(--fit);
      object-position: var(--pos);
      transform: scale(var(--zoom));
      filter: saturate(1.06) contrast(1.04);
      background: rgba(0,0,0,.15);
    }
    .envShade{
      position:absolute; inset:0;
      background:
        radial-gradient(900px 360px at 30% 0%, rgba(255,255,255,.14), transparent 58%),
        radial-gradient(700px 420px at 50% 70%, rgba(0,0,0,.12), rgba(0,0,0,.42)),
        linear-gradient(180deg, rgba(0,0,0,.06), rgba(0,0,0,.32));
      pointer-events:none;
    }
    .envLines{
      position:absolute; inset:0;
      opacity:.30;
      pointer-events:none;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.20));
    }

    /* Carta que sube al abrir */
    .envLetter{
      position:absolute;
      left:10%; right:10%;
      top:18%;
      height:70%;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 16px 32px rgba(0,0,0,.35);
      transform: translateY(34px);
      opacity:.95;
      transition: transform .75s cubic-bezier(.2,.85,.2,1), opacity .35s ease;
      display:flex; flex-direction:column; gap:10px;
      padding:14px;
      pointer-events:none;
    }
    .miniLine{height:10px; border-radius: 8px; background: rgba(255,255,255,.10)}
    .miniLine.w1{width:78%}
    .miniLine.w2{width:92%}
    .miniLine.w3{width:60%}

    /* Solapa */
    .envFlap{
      position:absolute;
      inset:0;
      pointer-events:none;
      transform-origin: 50% 22%;
      transform: rotateX(0deg);
      transition: transform .75s cubic-bezier(.2,.85,.2,1);
      backface-visibility:hidden;
    }
    .envFlap svg{width:100%; height:100%}

    /* Sello */
    .seal{
      position:absolute;
      left:50%;
      top:58%;
      transform: translate(-50%, -50%);
      width:64px;
      height:64px;
      display:grid;
      place-items:center;
      font-weight:900;
      color: rgba(255,255,255,.95);
      text-shadow: 0 2px 16px rgba(90,160,255,.55);
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.35), rgba(255,255,255,0) 55%),
        linear-gradient(180deg, rgba(70,150,255,.55), rgba(40,110,235,.38));
      border: 1px solid rgba(150,210,255,.55);
      box-shadow:
        0 16px 28px rgba(0,0,0,.38),
        0 0 26px rgba(80,160,255,.28),
        inset 0 1px 0 rgba(255,255,255,.30),
        inset 0 -10px 18px rgba(0,0,0,.22);
      clip-path: path("M 32 56 C 32 56 7 40 7 23 C 7 14 14 8 22 8 C 27 8 31 11 32 14 C 33 11 37 8 42 8 C 50 8 57 14 57 23 C 57 40 32 56 32 56 Z");
      pointer-events:none;
    }
    .seal::after{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(circle at 30% 22%, rgba(255,255,255,.40), transparent 60%);
      clip-path: inherit;
      pointer-events:none;
    }

    /* Estado abierto */
    .opened .envFlap{transform: rotateX(180deg)}
    .opened .envLetter{transform: translateY(-10px); opacity:1}

    /* CARTA */
    main{margin-top:16px; display:none}
    .paperWrap{padding:18px}
    .paper{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      overflow:hidden;
    }
    .paperHead{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .paperHead .small{color:var(--muted); font-size:13px}
    .paperBody{padding:16px}
    .letterTitle{margin:0 0 10px 0; font-size:18px; letter-spacing:.2px}
    .typeArea{
      font-size:15px; line-height:1.7;
      white-space: pre-wrap; word-break: break-word;
      min-height: 160px;
    }
    .cursor{
      display:inline-block; width:10px;
      transform: translateY(2px);
      animation: blink 1s steps(1) infinite;
      color: var(--accent);
      font-weight:900;
    }
    @keyframes blink{50%{opacity:0}}

    .photoBox{margin-top:14px; display:none; grid-template-columns: 1fr 1fr; gap:12px; align-items:start}
    @media (max-width: 820px){ .photoBox{grid-template-columns:1fr} }
    .photo{
      width:100%;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      overflow:hidden;
    }
    .photo img{width:100%; height:auto; display:block}
    .blocks{display:grid; gap:10px}
    .block{
      border:1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      background: rgba(0,0,0,.14);
      padding:14px;
    }
    .block h3{margin:0; font-size:15px}
    .block p{margin:6px 0 0 0; color:var(--muted); font-size:14px; line-height:1.55}

    /* ===== Confeti CANVAS (siempre visible) ===== */
    #confettiCanvas{
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
    }

    @media (prefers-reduced-motion: reduce){
      .envFlap, .envLetter{transition:none}
      .cursor{animation:none}
    }
  </style>
</head>

<body>
  <!-- Confeti en canvas -->
  <canvas id="confettiCanvas" aria-hidden="true"></canvas>

  <!-- Audio -->
  <audio id="bgm" src="musica.mp3" preload="auto" loop></audio>

  <div class="wrap">
    <header>
      <!--
        IMPORTANTE:
        NO BORRES ESTO si tu JS usa #toNameChip.
        Lo dejamos, pero oculto, para que NO salga arriba y NO te rompa el script.
      -->
      <div class="subtitle hidden" aria-hidden="true">‚ú® <span>De <b id="toNameChip">Irene</b> ‚Äî <b>2026</b></span></div>

      <div class="actions">
        <div class="audioCtl" aria-label="Control de m√∫sica">
          <button class="volBtn" id="volBtn" type="button" aria-label="Silenciar o activar m√∫sica" title="Silenciar / Activar">
            <span id="volIcon" aria-hidden="true">üîä</span>
          </button>
          <input class="volRange" id="volRange" type="range" min="0" max="100" value="60" aria-label="Volumen" />
          <span class="volHint" id="volTxt">60%</span>
        </div>
      </div>
    </header>

    <section class="hero panel" id="hero">
      <div class="heroGrid">
        <div class="left">
          <h1 class="title"><span id="toNameTitle">Irene</span>, <span class="spark">feliz 2026</span> üíù</h1>
          <p class="subtitle">
            Una personita especial, se merece una felicitaci√≥n de a√±o especial. Quer√≠a dejarte algo bonito para empezar el a√±o:
            una cartita escrita por m√≠, solo para ti. Si quieres leerla, tan solo tienes que pulsar en el sobre decorado con nuestra fotito.
            Al abrirlo, podr√°s escuchar una melod√≠a que te resultar√° familiar. Espero que te guste y te haga comenzar el 2026 con una sonrisa.
          </p>
          <div class="hint">üíå <span>Pulsa el sobre para abrir la carta</span></div>
        </div>

        <div class="right">
          <div>
            <div class="envelope" id="envelope" role="button" aria-label="Abrir carta" tabindex="0">
              <div class="envFrame">
                <div class="envPhoto">
                  <img id="envImgBg" class="bg" alt="" aria-hidden="true" />
                  <img id="envImgMain" class="main" alt="Imagen del sobre" />
                </div>

                <div class="envShade"></div>

                <div class="envLetter" aria-hidden="true">
                  <div class="miniLine w2"></div>
                  <div class="miniLine w1"></div>
                  <div class="miniLine w3"></div>
                  <div class="miniLine w2"></div>
                </div>

                <svg class="envLines" viewBox="0 0 400 300" preserveAspectRatio="none" aria-hidden="true">
                  <rect x="10" y="10" width="380" height="280" rx="18" ry="18"
                        fill="rgba(255,255,255,0.02)" stroke="rgba(255,255,255,0.20)" stroke-width="2"/>
                  <path d="M20 80 L200 185 L380 80" fill="none" stroke="rgba(255,255,255,0.24)" stroke-width="3" />
                  <path d="M20 285 L200 175 L380 285" fill="none" stroke="rgba(255,255,255,0.14)" stroke-width="2" />
                </svg>

                <div class="envFlap" aria-hidden="true">
                  <svg viewBox="0 0 400 300" preserveAspectRatio="none">
                    <path d="M20 80 L200 200 L380 80"
                          fill="rgba(0,0,0,0.18)" stroke="rgba(255,255,255,0.16)" stroke-width="2"/>
                    <path d="M20 80 L200 200 L380 80"
                          fill="none" stroke="rgba(255,255,255,0.18)" stroke-width="3"/>
                  </svg>
                </div>

                <div class="seal" id="seal">I</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <main id="content" class="panel">
      <div class="paperWrap">
        <div class="paper">
          <div class="paperHead">
            <div class="small" id="paperMeta">1 de enero de 2026</div>
            <div></div>
          </div>

          <div class="paperBody">
            <h2 class="letterTitle" id="letterHeading">Para la ni√±a m√°s bonita</h2>
            <div class="typeArea" id="typeArea"></div>

            <div class="photoBox" id="photoBox">
              <div class="photo"><img id="photoImg" alt="Foto" /></div>
              <div class="blocks" id="blocks"></div>
            </div>

          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const CONFIG = {
      toName: "Irene",
      fromName: "‚Äî Elena üíô",
      dateText: "1 de enero de 2026",

      envelopeImageUrl: "sobre.jpg",
      envelopeFitMode: "cover", // "cover" | "contain-blur"
      envelopePosition: "50% 35%",
      envelopeZoom: 1.03,

      photoUrl: "",

letterParagraphs: [
  "Dado que no puedo empezar el 2026 de manera f√≠sica contigo, d√°ndote muchos abracitos y comi√©ndote a besos, quiero dedicarte unas palabritas de manera virtual para que te llegue mi calorcito desde Espartinas.\n\n",
  "Ya sabes que no suelo hacer cierre de a√±o, pero no puedo evitar pensar en todo esto tan bonito que nos ha regalado la vida en el mes de octubre.\n\n",
  "Al principio me gener√≥ mucha intriga conocerte, ya que vi que ten√≠amos bastantes cosas en com√∫n y quer√≠a saber m√°s y m√°s de ti. Con el tiempo, lo que comenz√≥ siendo mensajes cada dos o tres d√≠as se convirti√≥ en largas conversaciones a diario, en las que sent√≠a que estaba conociendo a una ni√±a muy bonita en todos los sentidos. Poco a poco empec√© a tener sentimientos muy especiales por ti y fuiste gan√°ndote mi corazoncito.\n\n",
  "Este final de a√±o ha sido muy especial para m√≠ porque ha sido el momento en el que por fin pude verte en persona y comprobar que todo eso que estaba sintiendo no se quedaba en una pantalla, sino que era real. Ya no era solo la emoci√≥n de los mensajes o de las llamadas, sino la certeza de mirarte y reconocer esa sensaci√≥n de paz, de ‚Äúaqu√≠ estoy a gusto‚Äù. Y me encant√≥ darme cuenta de que contigo puedo ser yo misma, sin enmascarar ni sin forzar nada.\n\n",
  "Me quedo con la forma en la que nos miramos, con lo natural que fue todo, con la risa que sale sola y con esos silencios que no incomodan. Me quedo con lo f√°cil que resulta compartir tiempo contigo, con lo bonito que es sentirme cuidada y, a la vez, tener ganas de cuidarte. Con esa complicidad que estamos construyendo paso a paso, sin prisa, como si la vida nos estuviera indicando: ‚Äú'¬°s√≠, por aqu√≠!‚Äù.\n\n",
  "Quiero seguir compartiendo contigo momentos de risa, de l√°grimas, de ‚Äúobras‚Äù individuales y compartidas (con llaves inglesas y mucho rotaflex), de pelis, de freestyles, de conversaciones inc√≥modas que hacen que esto sea m√°s fuerte, y de planes improvisados. Quiero seguir estando cuando tengas un d√≠a bueno y tambi√©n cuando tengas un d√≠a de esos que pesan, para agarrarte la manita, escucharte y recordarte lo valiosa que eres, que no se te debe olvidar jam√°s. Quiero que sigamos ayud√°ndonos, empuj√°ndonos hacia lo mejor, poni√©ndonos tiritas de Cars o de cualquier dibujito que mole en las heridas cuando haga falta y celebrando juntas cada peque√±a victoria.\n\n",
  "Me encanta que podamos estar en la vida de la otra y sumar, sin restar, acompa√±√°ndonos sin perdernos a nosotras mismas. Y lo m√°s bonito de todo es que, sabiendo que podemos estar la una sin la otra, nos elegimos cada d√≠a de la manera m√°s sana posible.\n\n",
  "As√≠ que lo que le pido a 2025 es seguir conoci√©ndote m√°s, seguir descubriendo tus rinconcitos, tus heridas, tus man√≠as, tus sue√±os, tus miedos, y aumentar cada vez m√°s ese porcentaje de conocimiento. Tambi√©n seguir aprendiendo de ti, y que t√∫ tambi√©n puedas ir conoci√©ndome a m√≠, de esa forma tan bonita en la que nos estamos encontrando. Le pido a 2025 que nos siga regalando tiempo: momentos especiales, pero tambi√©n cotidianos, oportunidades para vernos, para abrazarnos, para mirarnos de cerca, y libertad para soltarnos y seguir fluyendo sin presiones.\n\n",
  "Quiero cerrar record√°ndote que te admiro y que estoy muy orgullosa de ti. Vas subiendo muchos pelda√±os de las escaleras y poniendo cientos de ladrillitos en la obra. Este a√±o has plantado cara a muchos de tus miedos y est√°s luchando como una campeona. La Irene de 2024 estar√≠a muy feliz si te viera en una pantallita ahora, y lo sabes. Eres muy valiosa y, por eso y por mucho m√°s, quiero seguir viendo a tu ladito lo que te depara el 2026, que seguro que trae muchas cositas bonitas. Y las que no sean tanto, ah√≠ me tendr√°s.\n\n",
  "Gracias por darme la oportunidad de conocerte.\n\n",
  "Con cari√±o,\n"
],


      

      // Audio
      initialVolume: 0.60
    };

    const hero = document.getElementById("hero");
    const envelope = document.getElementById("envelope");
    const content = document.getElementById("content");
    const typeArea = document.getElementById("typeArea");
    const toNameTitle = document.getElementById("toNameTitle");
    const toNameChip = document.getElementById("toNameChip");
    const seal = document.getElementById("seal");
    const paperMeta = document.getElementById("paperMeta");
    const letterHeading = document.getElementById("letterHeading");

    const envImgBg = document.getElementById("envImgBg");
    const envImgMain = document.getElementById("envImgMain");

    const photoBox = document.getElementById("photoBox");
    const photoImg = document.getElementById("photoImg");
    const blocks = document.getElementById("blocks");

    // Audio UI
    const bgm = document.getElementById("bgm");
    const volBtn = document.getElementById("volBtn");
    const volIcon = document.getElementById("volIcon");
    const volRange = document.getElementById("volRange");
    const volTxt = document.getElementById("volTxt");

    // ===== Confeti CANVAS (siempre visible) =====
    const confettiCanvas = document.getElementById("confettiCanvas");
    const confettiCtx = confettiCanvas.getContext("2d", { alpha: true });

    let confettiRunning = false;
    let confettiParticles = [];
    let confettiRAF = 0;

    function resizeConfettiCanvas(){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      confettiCanvas.width  = Math.floor(window.innerWidth * dpr);
      confettiCanvas.height = Math.floor(window.innerHeight * dpr);
      confettiCanvas.style.width = window.innerWidth + "px";
      confettiCanvas.style.height = window.innerHeight + "px";
      confettiCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    resizeConfettiCanvas();
    window.addEventListener("resize", resizeConfettiCanvas, { passive:true });

    function launchConfettiOnceFromElement(el){
      if (confettiRunning) return; // una sola vez
      confettiRunning = true;

      const r = el.getBoundingClientRect();
      const originX = r.left + r.width * 0.5;
      const originY = r.top  + r.height * 0.45;

      const colors = [
        "#ff4d6d","#ffd166","#06d6a0","#4dabf7","#b197fc","#ff9f1c",
        "#f72585","#72efdd","#f9c74f","#90be6d"
      ];

      const count = 180;
      confettiParticles = [];

      for (let i = 0; i < count; i++){
        const ang = Math.random() * Math.PI * 2;
        const sp  = 4 + Math.random() * 9;

        confettiParticles.push({
          x: originX,
          y: originY,
          vx: Math.cos(ang) * sp,
          vy: Math.sin(ang) * sp - (6 + Math.random() * 6),
          g: 0.22 + Math.random() * 0.12,
          w: 5 + Math.random() * 7,
          h: 7 + Math.random() * 10,
          rot: Math.random() * Math.PI,
          vrot: (Math.random() * 0.28 - 0.14),
          color: colors[(Math.random() * colors.length) | 0],
          life: 0,
          ttl: 1200 + Math.random() * 900
        });
      }

      const start = performance.now();

      function frame(now){
        const dt = now - start;
        confettiCtx.clearRect(0, 0, window.innerWidth, window.innerHeight);

        let alive = 0;

        for (const p of confettiParticles){
          p.life += 16.7;
          if (p.life > p.ttl) continue;

          alive++;
          p.vy += p.g;
          p.x += p.vx;
          p.y += p.vy;
          p.rot += p.vrot;

          const t = p.life / p.ttl;
          const alpha = (t < 0.75) ? 1 : (1 - (t - 0.75) / 0.25);

          confettiCtx.save();
          confettiCtx.globalAlpha = Math.max(0, Math.min(1, alpha));
          confettiCtx.translate(p.x, p.y);
          confettiCtx.rotate(p.rot);
          confettiCtx.fillStyle = p.color;
          confettiCtx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
          confettiCtx.restore();
        }

        if (alive > 0 && dt < 2600){
          confettiRAF = requestAnimationFrame(frame);
        } else {
          confettiCtx.clearRect(0, 0, window.innerWidth, window.innerHeight);
          cancelAnimationFrame(confettiRAF);
          confettiRunning = false;
        }
      }

      confettiRAF = requestAnimationFrame(frame);
    }

    if (toNameTitle) toNameTitle.textContent = CONFIG.toName;
    if (toNameChip) toNameChip.textContent = CONFIG.toName;
    if (seal) seal.textContent = (CONFIG.toName || "I").trim().charAt(0).toUpperCase();
    if (paperMeta) paperMeta.textContent = CONFIG.dateText;
    if (letterHeading) letterHeading.textContent = `Querida ${CONFIG.toName},`;

    if (envelope){
      envelope.style.setProperty("--pos", CONFIG.envelopePosition);
      envelope.style.setProperty("--zoom", String(CONFIG.envelopeZoom));

      if (CONFIG.envelopeFitMode === "contain-blur") {
        envelope.style.setProperty("--fit", "contain");
        envelope.style.setProperty("--showBlur", "1");
      } else {
        envelope.style.setProperty("--fit", "cover");
        envelope.style.setProperty("--showBlur", "0");
      }
    }

    // Imagen del sobre (esto era lo que se te romp√≠a si el script petaba)
    if (envImgBg) envImgBg.src = CONFIG.envelopeImageUrl;
    if (envImgMain) envImgMain.src = CONFIG.envelopeImageUrl;

    // Foto dentro de la carta + bloques
    if (CONFIG.photoUrl && CONFIG.photoUrl.trim() !== "") {
      if (photoImg) photoImg.src = CONFIG.photoUrl.trim();
      if (photoBox) photoBox.style.display = "grid";
      if (blocks){
        blocks.innerHTML = "";
        for (const b of CONFIG.highlightBlocks) {
          const d = document.createElement("div");
          d.className = "block";
          d.innerHTML = `<h3>${escapeHtml(b.title)}</h3><p>${escapeHtml(b.text)}</p>`;
          blocks.appendChild(d);
        }
      }
    } else {
      if (photoBox) photoBox.style.display = "none";
    }

    // ===== Audio =====
    function setVolume(v01){
      const clamped = Math.max(0, Math.min(1, v01));
      if (bgm) bgm.volume = clamped;
      const pct = Math.round(clamped * 100);
      if (volRange) volRange.value = String(pct);
      if (volTxt) volTxt.textContent = `${pct}%`;

      if (!volIcon || !bgm) return;
      if (bgm.muted || clamped === 0) volIcon.textContent = "üîá";
      else if (clamped < 0.5) volIcon.textContent = "üîâ";
      else volIcon.textContent = "üîä";
    }
    setVolume(CONFIG.initialVolume);

    async function tryPlayAudio(){ try{ if (bgm) await bgm.play(); }catch{} }
    tryPlayAudio();

    const unlockAudioOnce = async () => {
      try { if (bgm) await bgm.play(); } catch {}
      window.removeEventListener("pointerdown", unlockAudioOnce);
      window.removeEventListener("keydown", unlockAudioOnce);
    };
    window.addEventListener("pointerdown", unlockAudioOnce, { once:false });
    window.addEventListener("keydown", unlockAudioOnce, { once:false });

    if (volBtn){
      volBtn.addEventListener("click", async () => {
        if (!bgm) return;
        bgm.muted = !bgm.muted;
        if (!bgm.muted) { try { await bgm.play(); } catch {} }
        setVolume(bgm.volume);
      });
    }

    if (volRange){
      volRange.addEventListener("input", async (e) => {
        if (!bgm) return;
        const pct = Number(e.target.value || 0);
        const v = pct / 100;
        bgm.muted = (v === 0);
        setVolume(v);
        if (!bgm.muted) { try { await bgm.play(); } catch {} }
      });
    }

    // ===== Abrir + typewriter =====
    let opened = false;
    let typing = false;
    let cancelTyping = false;

    function openLetter(){
      if (opened) return;
      opened = true;

      if (hero) hero.classList.add("opened");
      if (envelope) envelope.classList.add("opened");

      if (envelope) launchConfettiOnceFromElement(envelope);

      if (content){
        content.style.display = "block";
        setTimeout(() => content.scrollIntoView({behavior:"smooth", block:"start"}), 220);
      }

      startTyping();
    }

    function startTyping(){
      if (typing || !typeArea) return;
      typing = true;
      cancelTyping = false;

      typeArea.textContent = "";
      const cursor = document.createElement("span");
      cursor.className = "cursor";
      cursor.textContent = "‚ñç";
      typeArea.appendChild(cursor);

      const fullText = CONFIG.letterParagraphs.join("");
      let i = 0;

      const tick = () => {
        if (!typeArea) return;

        if (cancelTyping){
          typeArea.textContent = fullText + "\n" + CONFIG.fromName;
          typing = false;
          return;
        }
        if (i >= fullText.length){
          typeArea.textContent = fullText + "\n" + CONFIG.fromName;
          typing = false;
          return;
        }
        cursor.insertAdjacentText("beforebegin", fullText.charAt(i));
        i++;

        const ch = fullText.charAt(i-1);
        const base = (ch === "\n") ? 120 : 22;
        const jitter = Math.random() * 22;
        setTimeout(tick, base + jitter);
      };

      tick();
    }

    // Eventos: SOLO SOBRE
    if (envelope){
      envelope.addEventListener("click", openLetter);
      envelope.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") openLetter();
      });
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
  });
  </script>
</body>
</html>
